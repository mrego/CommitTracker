import{_ as Ct}from"./BCSySVuw.js";import{s as j,t as lt,c as ut}from"./B6qCbaoP.js";import{f as Dt,G as $t,h as G,y as dt,n as It,p as ft,q as St,r as Nt,o as Z,c as Q,a as $,W as ht,s as L,F as kt,j as xt,b as Mt,t as jt,i as qt,X as Et,Y as Lt}from"./B29pliZ2.js";import{a as P}from"./DxPSARot.js";import{l as Ft}from"./ntdiYfc-.js";import{f as bt}from"./D2nGpDRe.js";import{_ as Ot}from"./DlAUqK2U.js";function Vt(t){var n=0,o=t.children,a=o&&o.length;if(!a)n=1;else for(;--a>=0;)n+=o[a].value;t.value=n}function Ht(){return this.eachAfter(Vt)}function Pt(t,n){let o=-1;for(const a of this)t.call(n,a,++o,this);return this}function Wt(t,n){for(var o=this,a=[o],c,f,u=-1;o=a.pop();)if(t.call(n,o,++u,this),c=o.children)for(f=c.length-1;f>=0;--f)a.push(c[f]);return this}function Xt(t,n){for(var o=this,a=[o],c=[],f,u,v,z=-1;o=a.pop();)if(c.push(o),f=o.children)for(u=0,v=f.length;u<v;++u)a.push(f[u]);for(;o=c.pop();)t.call(n,o,++z,this);return this}function Yt(t,n){let o=-1;for(const a of this)if(t.call(n,a,++o,this))return a}function Gt(t){return this.eachAfter(function(n){for(var o=+t(n.data)||0,a=n.children,c=a&&a.length;--c>=0;)o+=a[c].value;n.value=o})}function Zt(t){return this.eachBefore(function(n){n.children&&n.children.sort(t)})}function Jt(t){for(var n=this,o=Kt(n,t),a=[n];n!==o;)n=n.parent,a.push(n);for(var c=a.length;t!==o;)a.splice(c,0,t),t=t.parent;return a}function Kt(t,n){if(t===n)return t;var o=t.ancestors(),a=n.ancestors(),c=null;for(t=o.pop(),n=a.pop();t===n;)c=t,t=o.pop(),n=a.pop();return c}function Qt(){for(var t=this,n=[t];t=t.parent;)n.push(t);return n}function Ut(){return Array.from(this)}function te(){var t=[];return this.eachBefore(function(n){n.children||t.push(n)}),t}function ee(){var t=this,n=[];return t.each(function(o){o!==t&&n.push({source:o.parent,target:o})}),n}function*ne(){var t=this,n,o=[t],a,c,f;do for(n=o.reverse(),o=[];t=n.pop();)if(yield t,a=t.children)for(c=0,f=a.length;c<f;++c)o.push(a[c]);while(o.length)}function pt(t,n){t instanceof Map?(t=[void 0,t],n===void 0&&(n=re)):n===void 0&&(n=ae);for(var o=new ot(t),a,c=[o],f,u,v,z;a=c.pop();)if((u=n(a.data))&&(z=(u=Array.from(u)).length))for(a.children=u,v=z-1;v>=0;--v)c.push(f=u[v]=new ot(u[v])),f.parent=a,f.depth=a.depth+1;return o.eachBefore(se)}function oe(){return pt(this).eachBefore(ie)}function ae(t){return t.children}function re(t){return Array.isArray(t)?t[1]:null}function ie(t){t.data.value!==void 0&&(t.value=t.data.value),t.data=t.data.data}function se(t){var n=0;do t.height=n;while((t=t.parent)&&t.height<++n)}function ot(t){this.data=t,this.depth=this.height=0,this.parent=null}ot.prototype=pt.prototype={constructor:ot,count:Ht,each:Pt,eachAfter:Xt,eachBefore:Wt,find:Yt,sum:Gt,sort:Zt,path:Jt,ancestors:Qt,descendants:Ut,leaves:te,links:ee,copy:oe,[Symbol.iterator]:ne};function ce(t){if(typeof t!="function")throw new Error;return t}function tt(){return 0}function et(t){return function(){return t}}function le(t){t.x0=Math.round(t.x0),t.y0=Math.round(t.y0),t.x1=Math.round(t.x1),t.y1=Math.round(t.y1)}function ue(t,n,o,a,c){for(var f=t.children,u,v=-1,z=f.length,x=t.value&&(a-n)/t.value;++v<z;)u=f[v],u.y0=o,u.y1=c,u.x0=n,u.x1=n+=u.value*x}function de(t,n,o,a,c){for(var f=t.children,u,v=-1,z=f.length,x=t.value&&(c-o)/t.value;++v<z;)u=f[v],u.x0=n,u.x1=a,u.y0=o,u.y1=o+=u.value*x}var fe=(1+Math.sqrt(5))/2;function he(t,n,o,a,c,f){for(var u=[],v=n.children,z,x,m=0,d=0,e=v.length,_,w,k=n.value,p,M,I,F,q,R,S;m<e;){_=c-o,w=f-a;do p=v[d++].value;while(!p&&d<e);for(M=I=p,R=Math.max(w/_,_/w)/(k*t),S=p*p*R,q=Math.max(I/S,S/M);d<e;++d){if(p+=x=v[d].value,x<M&&(M=x),x>I&&(I=x),S=p*p*R,F=Math.max(I/S,S/M),F>q){p-=x;break}q=F}u.push(z={value:p,dice:_<w,children:v.slice(m,d)}),z.dice?ue(z,o,a,c,k?a+=w*p/k:f):de(z,o,a,k?o+=_*p/k:c,f),k-=p,m=d}return u}const pe=function t(n){function o(a,c,f,u,v){he(n,a,c,f,u,v)}return o.ratio=function(a){return t((a=+a)>1?a:1)},o}(fe);function me(){var t=pe,n=!1,o=1,a=1,c=[0],f=tt,u=tt,v=tt,z=tt,x=tt;function m(e){return e.x0=e.y0=0,e.x1=o,e.y1=a,e.eachBefore(d),c=[0],n&&e.eachBefore(le),e}function d(e){var _=c[e.depth],w=e.x0+_,k=e.y0+_,p=e.x1-_,M=e.y1-_;p<w&&(w=p=(w+p)/2),M<k&&(k=M=(k+M)/2),e.x0=w,e.y0=k,e.x1=p,e.y1=M,e.children&&(_=c[e.depth+1]=f(e)/2,w+=x(e)-_,k+=u(e)-_,p-=v(e)-_,M-=z(e)-_,p<w&&(w=p=(w+p)/2),M<k&&(k=M=(k+M)/2),t(e,w,k,p,M))}return m.round=function(e){return arguments.length?(n=!!e,m):n},m.size=function(e){return arguments.length?(o=+e[0],a=+e[1],m):[o,a]},m.tile=function(e){return arguments.length?(t=ce(e),m):t},m.padding=function(e){return arguments.length?m.paddingInner(e).paddingOuter(e):m.paddingInner()},m.paddingInner=function(e){return arguments.length?(f=typeof e=="function"?e:et(+e),m):f},m.paddingOuter=function(e){return arguments.length?m.paddingTop(e).paddingRight(e).paddingBottom(e).paddingLeft(e):m.paddingTop()},m.paddingTop=function(e){return arguments.length?(u=typeof e=="function"?e:et(+e),m):u},m.paddingRight=function(e){return arguments.length?(v=typeof e=="function"?e:et(+e),m):v},m.paddingBottom=function(e){return arguments.length?(z=typeof e=="function"?e:et(+e),m):z},m.paddingLeft=function(e){return arguments.length?(x=typeof e=="function"?e:et(+e),m):x},m}function ge(t,n,o,a,c){var f=t.children,u,v=f.length,z,x=new Array(v+1);for(x[0]=z=u=0;u<v;++u)x[u+1]=z+=f[u].value;m(0,v,t.value,n,o,a,c);function m(d,e,_,w,k,p,M){if(d>=e-1){var I=f[d];I.x0=w,I.y0=k,I.x1=p,I.y1=M;return}for(var F=x[d],q=_/2+F,R=d+1,S=e-1;R<S;){var U=R+S>>>1;x[U]<q?R=U+1:S=U}q-x[R-1]<x[R]-q&&d+1<R&&--R;var W=x[R]-F,X=_-W;if(p-w>M-k){var J=_?(w*X+p*W)/_:p;m(d,R,W,w,k,J,M),m(R,e,X,J,k,p,M)}else{var nt=_?(k*X+M*W)/_:M;m(d,R,W,w,k,p,nt),m(R,e,X,w,nt,p,M)}}}const ve={class:"sticky top section"},_e={class:"section",style:{"padding-top":"0"}},ye={class:"container"},we={key:0,style:{height:"70vh"}},ke=["width","height"],xe={class:"section"},Me={class:"container"},be=["width","height"],ze={class:"sticky bottom section"},Be=Dt({__name:"Treemap",props:{repositories:{type:Array[String],default:()=>["chromium"]},path:{},field_color:{},field_size:{},colormap:{},colormapMin:{},colormapMax:{},dates:{},animate:{type:Boolean,default:!1}},emits:["zoomin","animationend"],setup(t,{emit:n}){const{$color_map:o}=$t(),a=G(null),c=G(null),f=G(null);G(null);const u=G("Tooltip"),v=dt(void 0),z=dt({}),x=dt([]);let m=o[0];const d=t,e=n,_=G(600),w=G(600),k=function(i){let r=0;for(const h of d.field_color)r+=i.summed_data[h]||0;return r},p=function(i){let r=0;for(const h of d.field_size)r+=i.summed_data[h]||0;return r},M=function(i,r,h){return i.attr("transform",s=>`translate(${r(s.x0)}, ${h(s.y0)})`)},I=function(i,r,h,s){return i.attr("rx",10).attr("stroke","white").attr("stroke-width",5).attr("fill-opacity",.9).attr("width",l=>r(l.x1)-r(l.x0)).attr("height",l=>h(l.y1)-h(l.y0)).style("fill",l=>{const g=P().domain([d.colormapMin||0,d.colormapMax||1]).range([0,1]),b=k(l.data),T=p(l.data),y="gray",A=m(g(b/T));return Et(y,A)(s?.5:.9)})},F=function(i,r){return i.attr("text-anchor","start").attr("alignment-baseline","middle").attr("x",8).attr("opacity",.5-r*.2).style("font-weight",r==0?"bold":"normal")},q=function(i,r,h){const s=P().domain([d.colormapMin||0,d.colormapMax||1]).range([0,1]),l=g=>{const b=p(h.data),y=p(g.data)/b*10;return y<.02?0:Math.min(20,Math.sqrt(y)*30)};return i.style("fill",g=>{const b=k(g.data),T=p(g.data),y=m(s(b/T));return Lt(y).l<.5?"white":"black"}).style("font-size",l).attr("y",g=>5+l(g)*(r+1)*1.2).text(g=>{const b=g.data.name,T=k(g.data),y=p(g.data),A=Math.floor(100*T/y);return r==0?`${b}`:`${T}/${y} = ${A}%`})},R=function(i,r,h,s,l=!1,g){const T=(y=>y.join(A=>{const B=A.append("g"),C=B.append("rect"),D=B.append("text"),N=B.append("text");return M(B,h,s),I(C,h,s,!1),F(D,0),F(N,1),q(D,0,r),q(N,1,r),B},A=>{const B=A.transition(g),C=B.select("rect"),D=B.selectAll("text");return M(B,h,s),I(C,h,s,!1),D.each((N,V,H)=>{const K=j(H[V]),rt=l?K:K.transition(g);q(rt,V,r)}),A},A=>A.remove()))(i.selectAll("g").data(r.children,y=>y.data.name));T.filter(y=>y.children).attr("cursor","pointer").on("click",(y,A)=>S(A)),T.on("mousemove",(y,A)=>{const B=j(y.currentTarget).select("rect");I(B,h,s,!0),u.value=A.data.name,j(f.value).style("opacity",1),a.value.getBoundingClientRect();const C=c.value.getBoundingClientRect(),D=f.value.getBoundingClientRect(),N=C.right-D.width,V=C.bottom-D.height;let H=Math.min(y.clientX+20,N),K=Math.min(y.clientY+20,V);H==N&&K==V&&(H=y.clientX-D.width-20,K=y.clientY-D.height-20),j(f.value).style("left",H-C.left+"px").style("top",K-C.top+"px");const rt=[].concat(d.field_size).concat(d.field_color),wt=O=>{const Y=O.select("td.v1"),it=O.select("td.v2"),st=O.select("td.v3"),ct=O.select("td.v4");return Y.text(E=>E),it.text(E=>A.data.summed_data[E]||0),st.text(E=>r.data.summed_data[E]||0),ct.text(E=>{const At=A.data.summed_data[E]||0,Tt=r.data.summed_data[E]||0;return Math.floor(100*At/Tt)+"%"}),O};j(f.value).select("tbody").selectAll("tr").data(rt).join(O=>{const Y=O.append("tr"),it=Y.append("td"),st=Y.append("td"),ct=Y.append("td"),E=Y.append("td");return it.attr("class","v1"),st.attr("class","v2"),ct.attr("class","v3"),E.attr("class","v4"),wt(Y)},wt,O=>O.remove())}).on("mouseleave",(y,A)=>{const B=j(y.currentTarget).select("rect");I(B,h,s,!1),j(f.value).style("opacity",0)})},S=function(i){e("zoomin",i.data.name)},U=async function(i,r){const h=lt().duration(0).ease(ut),s=lt().duration(500).ease(ut),l=j(c.value).select("g"),g=j(c.value).append("g");{const b=P().domain([i.x0,i.x1]).rangeRound([0,_.value]),T=P().domain([i.y0,i.y1]).rangeRound([0,w.value]);R(l,i,b,T,!0,h),R(g,r,b,T,!0,h)}{const b=P().domain([r.x0,r.x1]).rangeRound([0,_.value]),T=P().domain([r.y0,r.y1]).rangeRound([0,w.value]);R(l,i,b,T,!0,s),R(g,r,b,T,!0,s)}l.attr("opacity",1).transition(s).attr("opacity",0),g.attr("opacity",0).transition(s).attr("opacity",1),l.transition(s).remove(),await s.end(),await gt(r.data)},W=function(i){const r=pt(i).sum(l=>l.children.length?0:p(l));return me().tile(ge).size([_.value,w.value*1.8]).round(!0)(r)},X=new Date("2020-01-01"),J=i=>Math.floor((i-X)/(7*24*60*60*1e3)),nt=i=>new Date(X.getTime()+i*7*24*60*60*1e3),mt=function(i){const r=J(d.dates[1]),h=s=>{s.children||(s.children=[]);const l={};s.data&&Object.keys(s.data).sort((g,b)=>parseInt(g)-parseInt(b)).filter(g=>parseInt(g)<=r).forEach(g=>{for(const b in s.data[g])l[b]=s.data[g][b]});for(const g of s.children){h(g);for(const b in g.summed_data)l[b]||(l[b]=0),l[b]+=g.summed_data[b]}s.summed_data=l};h(i)},gt=async i=>{const r=new Date,h=J(d.dates[0]),s=J(d.dates[1]),l=[].concat(d.field_size).concat(d.field_color),g=[];for(const T of l){await new Promise(B=>setTimeout(B,0));const y=Array(s+1).fill(0),A=[i];for(;A.length>0;){const B=A.pop();for(const D of B.children)A.push(D);if(!B.data)continue;let C=0;Object.keys(B.data).sort((D,N)=>D-N).forEach(D=>{var H;const N=(H=B.data[D])==null?void 0:H[T];if(N===void 0)return;const V=parseInt(D);V<=s&&(y[V]+=N-C),C=N})}y.forEach((B,C)=>{C>0&&(y[C]+=y[C-1])}),y.splice(0,h),g.push({label:T,extra_label:" = "+bt(",d")(y.slice(-1)[0]),formatter:bt(",d"),values:y.map((B,C)=>({x:nt(h+C),y:B}))})}x.value=g,console.log("Historical data computed in",(new Date-r)/1e3,"seconds")},zt=async function(){if(v.value)return;const i=s=>{if(!s.children){for(const g of[".h",".cc",".cpp",".c",".hpp"])if(s.name.endsWith(g))return s;return null}const l=s.children.map(i).filter(g=>g);return l.length==0?null:{...s,children:l}},r=await fetch(`/treemap/${d.repositories[0]}/latest.json`),h=i(await r.json());mt(h),v.value=h},at=function(i){let r=z.value;for(const h of i)for(let s of r.children)if(s.data.name==h){r=s;break}return r},vt=async function(){m=o[d.colormap],j(c.value).select("g").node()||j(c.value).append("g");const i=at(d.path),r=j(c.value).select("g"),h=P().domain([i.x0,i.x1]).rangeRound([0,_.value]),s=P().domain([i.y0,i.y1]).rangeRound([0,w.value]),l=lt().duration(300).ease(d.animate?ut:Ft);R(r,i,h,s,!1,l),await l.end(),await gt(i.data),console.log("emit animationend"),e("animationend")},_t=async function(){await new Promise(i=>setTimeout(i,0)),mt(v.value),z.value=W(v.value),await vt()},Bt=async function(i,r){const h=at(r),s=at(i);await U(h,s)},Rt=It(()=>[...d.path]);ft(()=>[d.repositories,d.field_size,d.field_color,d.dates],_t),ft(()=>[d.colormap,d.colormapMin,d.colormapMax],vt),ft(Rt,Bt);const yt=async function(){for(;!a.value;)await new Promise(i=>setTimeout(i,100));_.value=a.value.clientWidth,w.value=Math.max(_.value*.5,window.innerHeight-300),await _t()};return St(async()=>{await zt(),yt(),window.addEventListener("resize",yt)}),(i,r)=>{const h=Nt("b-skeleton"),s=Ct;return Z(),Q("div",null,[$("div",ve,[ht(i.$slots,"top",{},void 0,!0)]),$("div",_e,[$("div",ye,[L(v)?(Z(),Q("div",{key:1,ref_key:"container",ref:a},[$("table",{class:"treemap-tooltip",ref_key:"tooltip",ref:f},[$("thead",null,[$("tr",null,[$("td",null,jt(L(u)),1),r[0]||(r[0]=$("td",null," . ",-1)),r[1]||(r[1]=$("td",null," .. ",-1)),r[2]||(r[2]=$("td",null," % ",-1))])]),r[3]||(r[3]=$("tbody",null,null,-1))],512),(Z(),Q("svg",{width:L(_),height:L(w)},[$("g",{ref_key:"content",ref:c},null,512)],8,ke)),ht(i.$slots,"colormap",{},void 0,!0)],512)):(Z(),Q("div",we,[(Z(),Q(kt,null,xt(20,l=>Mt(h,{key:l,width:(l*16546+13*l*l)%100+"%",animated:""},null,8,["width"])),64))]))])]),$("div",xe,[$("div",Me,[$("div",{width:L(_),height:L(w)},[L(x)?(Z(),qt(s,{key:0,data:L(x),width:L(_),height:L(w)},null,8,["data","width","height"])):(Z(),Q(kt,{key:1},xt(20,l=>Mt(h,{key:l,width:(l*16546+13*l*l)%100+"%",animated:""},null,8,["width"])),64))],8,be)])]),$("div",ze,[ht(i.$slots,"bottom",{},void 0,!0)])])}}}),Ne=Ot(Be,[["__scopeId","data-v-897737a2"]]);export{Ne as _};
